name: MLOps Pipeline

on:
  workflow_dispatch:
    inputs:
      run_all:
        description: "Run all jobs"
        required: false
        default: "true"
  push:
    branches: [ main, master ]

jobs:
  data-processing:
    name: Data Processing
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: "3.11.9"
      - run: pip install -r requirements.txt
      - run: python src/data/run_processing.py --input data/raw/house_data.csv --output data/processed/cleaned_house_data.csv
      - uses: actions/upload-artifact@v4
        with:
          name: processed-data
          path: data/processed/cleaned_house_data.csv

  feature-engineering:
    name: Feature Engineering
    needs: data-processing
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: "3.11.9"
      - run: pip install -r requirements.txt
      - run: mkdir -p data/processed models/trained
      - uses: actions/download-artifact@v4
        with:
          name: processed-data
          path: data/processed/
      - run: python src/features/engineer.py --input data/processed/cleaned_house_data.csv --output data/processed/featured_house_data.csv --preprocessor models/trained/preprocessor.pkl
      - uses: actions/upload-artifact@v4
        with:
          name: featured-data
          path: |
            data/processed/featured_house_data.csv
            models/trained/preprocessor.pkl

  model-training:
    name: Model Training
    needs: feature-engineering
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: "3.11.9"
      - run: pip install -r requirements.txt
      - run: mkdir -p data/processed models/trained configs
      
      # Descargar artefactos del paso anterior
      - uses: actions/download-artifact@v4
        with:
          name: featured-data
          path: ./artifacts
      
      # Mover los artefactos a sus carpetas correctas
      - run: |
          mv artifacts/featured_house_data.csv data/processed/
          mv artifacts/preprocessor.pkl models/trained/
      
      # Entrenar el modelo (Sin MLflow URI para evitar errores de conexi√≥n en GitHub)
      - run: |
          python src/models/train_model.py --config configs/model_config.yaml --data data/processed/featured_house_data.csv --models-dir models
      
      # Guardar el modelo entrenado
      - uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: |
            models/trained/house_price_model.pkl
            models/trained/house_price_model.yaml